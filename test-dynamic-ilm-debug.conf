# Debug Configuration for Dynamic ILM Testing
# This will help you verify if dynamic ILM is working

input {
  generator {
    lines => [
      '{"message": "Test event 1", "container_name": "testapp"}',
      '{"message": "Test event 2", "container_name": "testapp"}',
      '{"message": "Test event 3", "container_name": "anotherapp"}'
    ]
    count => 3
    codec => json
  }
}

filter {
  # Ensure container_name exists and is lowercase
  if ![container_name] {
    mutate {
      add_field => { "container_name" => "default-container" }
    }
  }
  
  mutate {
    lowercase => ["container_name"]
  }
  
  # Add timestamp
  mutate {
    add_field => { "[@metadata][debug]" => "Container: %{[container_name]}" }
  }
}

output {
  # Print to stdout to see what's happening
  stdout {
    codec => rubydebug {
      metadata => true
    }
  }
  
  elasticsearch {
    hosts => ["http://eck-es-http:9200"]
    user => "elastic"
    password => "your-password-here"
    
    # CRITICAL: Enable ILM
    ilm_enabled => true
    
    # CRITICAL: Dynamic rollover alias using container_name    ilm_rollover_alias => "%{[container_name]}"
    
    # ILM policy configuration
    # NOTE: ilm_policy is IGNORED - policies are auto-created as "{container_name}-ilm-policy"
    # For example: "testapp-ilm-policy", "anotherapp-ilm-policy"
    # ilm_policy => "logstash-policy"  # <-- NOT USED in dynamic mode
    ilm_rollover_max_age => "1d"
    ilm_delete_min_age => "7d"
    ilm_delete_enabled => true
    
    # Disable SSL for testing
    ssl_verification_mode => "none"
    
    # ECS compatibility
    ecs_compatibility => "disabled"
  }
}

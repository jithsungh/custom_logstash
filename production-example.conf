# Production Logstash Configuration with Dynamic ILM
# This example shows a complete pipeline for Kubernetes logs

input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/etc/logstash/certs/logstash.crt"
    ssl_key => "/etc/logstash/certs/logstash.key"
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      skip_on_invalid_json => true
    }
  }
  
  # Ensure container_name exists (fallback to default)
  if ![container_name] {
    if [kubernetes][container][name] {
      mutate {
        add_field => { "container_name" => "%{[kubernetes][container][name]}" }
      }
    } else {
      mutate {
        add_field => { "container_name" => "unknown" }
      }
    }
  }
  
  # Normalize container_name (lowercase, remove special chars)
  mutate {
    lowercase => ["container_name"]
    gsub => [
      "container_name", "[^a-z0-9-]", "-"
    ]
  }
  
  # Add namespace if available
  if [kubernetes][namespace] {
    mutate {
      lowercase => ["kubernetes][namespace]"]
    }
  }
  
  # Parse timestamps
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }
  
  # Remove unnecessary fields to save space
  mutate {
    remove_field => ["agent", "ecs", "input", "log", "host"]
  }
}

output {
  # Elasticsearch with Dynamic ILM
  elasticsearch {
    # Cluster endpoints
    hosts => ["https://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    
    # Enable ILM
    ilm_enabled => true
    
    # Dynamic rollover alias pattern
    # This will create indices like: production-nginx-2025.11.17-000001
    ilm_rollover_alias => "%{[kubernetes][namespace]}-%{[container_name]}"
    
    # ILM policy settings
    ilm_policy => "k8s-logs-policy"
    ilm_rollover_max_age => "1d"
    ilm_rollover_max_size => "50gb"
    ilm_rollover_max_docs => 100000000
    ilm_delete_min_age => "30d"
    ilm_delete_enabled => true
    
    # SSL configuration
    ssl_enabled => true
    ssl_verification_mode => "certificate"
    cacert => "/etc/logstash/certs/ca.crt"
    
    # Performance settings
    bulk_size => 1000
    flush_interval_seconds => 5
    pool_max => 512
    pool_max_per_route => 256
    
    # Retry configuration
    retry_on_conflict => 3
    retry_initial_delay => 2
    retry_max_interval => 64
    
    # ECS compatibility
    ecs_compatibility => "disabled"
  }
  
  # Optional: Dead letter queue for failed events
  # file {
  #   path => "/var/log/logstash/failed_events_%{+YYYY.MM.dd}.log"
  #   codec => json_lines
  # }
}

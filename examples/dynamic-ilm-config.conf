# ============================================================================
# Dynamic ILM Configuration Example for Logstash Elasticsearch Output
# ============================================================================
#
# This configuration demonstrates how to use dynamic ILM with sprintf-style
# substitution for container_name fields. The plugin will automatically:
#
# 1. Create ILM policies per container (e.g., "auto-nginx-ilm-policy")
# 2. Create index templates per container (e.g., "logstash-auto-nginx")
# 3. Create rollover indices with date suffix (e.g., "auto-nginx-2025.11.20-000001")
# 4. Handle Logstash restarts and external resource deletions
# 5. Perform thread-safe concurrent event processing
# 6. Validate all resource names and configurations
# 7. Detect and recover from anomalies
#
# ============================================================================

input {
  # Example: Reading from a file with container logs
  file {
    path => "/var/log/containers/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
  }
  
  # Example: Reading from beats
  beats {
    port => 5044
  }
  
  # Example: Reading from stdin for testing
  stdin {
    codec => json
  }
}

filter {
  # Extract container_name from log path or metadata
  # This field will be used for dynamic index/policy/template creation
  
  if [log][file][path] {
    # Extract container name from file path
    # Example: /var/log/containers/nginx-abc123.log -> nginx
    grok {
      match => { "[log][file][path]" => "/var/log/containers/%{DATA:container_name}[-_]" }
    }
  }
  
  # Fallback: Use a default container name if not found
  if ![container_name] {
    mutate {
      add_field => { "container_name" => "default" }
    }
  }
  
  # Sanitize container_name (lowercase, no special chars)
  mutate {
    lowercase => ["container_name"]
    gsub => [
      "container_name", "[^a-z0-9-]", "-"
    ]
  }
  
  # Add timestamp if not present
  if ![timestamp] {
    ruby {
      code => "event.set('timestamp', Time.now.utc)"
    }
  }
}

output {
  # ============================================================================
  # Dynamic ILM Elasticsearch Output Configuration
  # ============================================================================
  
  elasticsearch {
    # Connection settings
    hosts => ["eck-es-http:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD:secure_password}"
    
    # SSL/TLS settings (recommended for production)
    ssl => true
    cacert => "/etc/logstash/certs/ca.crt"
    ssl_certificate_verification => true
    
    # ========================================================================
    # Dynamic ILM Configuration
    # ========================================================================
    
    # Enable ILM with dynamic rollover alias
    ilm_enabled => true
    
    # IMPORTANT: Use sprintf syntax for dynamic container-based indexing
    # The %{[container_name]} will be replaced with actual container name
    # Format: auto-%{[container_name]}-%{+YYYY.MM.dd}
    index => "auto-%{[container_name]}-%{+YYYY.MM.dd}"
    
    # Dynamic rollover alias template (will create alias per container)
    # This creates: auto-nginx, auto-apache, auto-mysql, etc.
    ilm_rollover_alias => "%{[container_name]}"
    
    # ========================================================================
    # ILM Policy Settings (Applied to ALL dynamic policies)
    # ========================================================================
    
    # Hot phase configuration
    # Maximum age before rollover (how old before creating new index)
    ilm_rollover_max_age => "1d"
    
    # Maximum size before rollover (optional)
    ilm_rollover_max_size => "50gb"
    
    # Maximum documents before rollover (optional)
    ilm_rollover_max_docs => 1000000
    
    # Hot phase index priority (higher = recovered first after restart)
    ilm_hot_priority => 100
    
    # Delete phase configuration
    # Enable automatic deletion of old indices
    ilm_delete_enabled => true
    
    # Minimum age before deletion (how long to keep data)
    ilm_delete_min_age => "7d"
    
    # ========================================================================
    # Template Management
    # ========================================================================
    
    # Disable static template management (dynamic templates are auto-created)
    manage_template => false
    
    # ========================================================================
    # Performance Settings
    # ========================================================================
    
    # Number of worker threads (adjust based on your system)
    workers => 4
    
    # Bulk request settings
    flush_size => 1000
    idle_flush_time => 5
    
    # ========================================================================
    # Error Handling
    # ========================================================================
    
    # Retry failed requests
    retry_max_interval => 5
    retry_initial_interval => 1
    
    # Dead letter queue for failed events
    # (requires DLQ to be enabled in logstash.yml)
    # dlq_custom_codes => [404, 400]
  }
  
  # Optional: Also output to stdout for debugging
  # Uncomment during development/testing
  # stdout {
  #   codec => rubydebug {
  #     metadata => true
  #   }
  # }
}

# ============================================================================
# Expected Elasticsearch Resources Created
# ============================================================================
#
# For each unique container_name value (e.g., "nginx"), the plugin creates:
#
# 1. ILM Policy: "auto-nginx-ilm-policy"
#    - Hot phase: rollover after 1d or 50gb or 1M docs
#    - Delete phase: delete after 7d
#
# 2. Index Template: "logstash-auto-nginx"
#    - Pattern: "auto-nginx-*"
#    - Priority: 100
#    - ILM settings: references "auto-nginx-ilm-policy"
#
# 3. Rollover Index: "auto-nginx-2025.11.20-000001"
#    - Alias: "auto-nginx" (is_write_index: true)
#    - Subsequent rollovers: "auto-nginx-2025.11.20-000002", etc.
#    - New day: "auto-nginx-2025.11.21-000001"
#
# ============================================================================
# Thread Safety and Caching
# ============================================================================
#
# - First event for a container triggers resource creation
# - Subsequent events use cached resources (no API calls)
# - Multiple Logstash workers process events concurrently
# - Atomic operations prevent race conditions
# - Cache survives for entire Logstash lifecycle
#
# On Logstash restart:
# - Cache is cleared
# - Plugin checks Elasticsearch for existing resources
# - Reuses existing resources or creates if missing
#
# ============================================================================
# Validation and Anomaly Detection
# ============================================================================
#
# The plugin automatically:
# - Validates container_name field exists and is valid
# - Sanitizes index names (lowercase, no invalid chars)
# - Detects missing container_name -> uses fallback
# - Detects initialization loops -> auto-recovers
# - Validates ILM policy structure
# - Verifies all resources after creation
# - Handles concurrent creation by multiple instances
#
# ============================================================================
# Troubleshooting
# ============================================================================
#
# To view logs:
#   tail -f /var/log/logstash/logstash-plain.log
#
# To verify resources in Elasticsearch:
#   # List all ILM policies
#   GET /_ilm/policy
#
#   # List all index templates
#   GET /_index_template
#
#   # List all indices and aliases
#   GET /_cat/aliases?v
#   GET /_cat/indices?v
#
# To manually clear cache for a container (if needed):
#   # Restart Logstash or wait for automatic recovery
#
# To delete all dynamic resources for a container:
#   DELETE /auto-nginx-*
#   DELETE /_index_template/logstash-auto-nginx
#   DELETE /_ilm/policy/auto-nginx-ilm-policy
#
# ============================================================================

input {
  stdin {
    codec => json
  }
}

filter {
  # Validate container_name exists
  if ![container_name] {
    mutate {
      add_field => { "container_name" => "default" }
    }
  }
  
  # Normalize container_name for ES data stream naming rules
  # ES data streams require: lowercase, no hyphens in certain positions
  mutate {
    # Convert to lowercase
    lowercase => ["container_name"]
    
    # Replace any invalid characters with underscore
    # Valid: letters, numbers, underscore, hyphen (with restrictions)
    gsub => [
      "container_name", "[^a-z0-9_-]", "_"
    ]
  }
  
  # Additional validation: ensure it doesn't start with hyphen or underscore
  ruby {
    code => '
      container = event.get("container_name")
      if container
        # Remove leading hyphens/underscores
        container = container.sub(/^[-_]+/, "")
        # Ensure it is not empty after cleanup
        container = "default" if container.empty?
        event.set("container_name", container)
      end
    '
  }
  
  # Set data_stream fields on the event
  # This is where sprintf substitution ACTUALLY works!
  mutate {
    add_field => {
      "[data_stream][type]" => "logs"
      "[data_stream][dataset]" => "%{[container_name]}"  # âœ… sprintf works here!
      "[data_stream][namespace]" => "default"
    }
  }
  
  # Optional: Add timestamp if missing
  if ![timestamp] {
    ruby {
      code => 'event.set("timestamp", Time.now.utc.iso8601)'
    }
  }
}

output {
  elasticsearch {
    hosts => ["eck-es-http:9200"]
    user => "elastic"
    password => "password"
    ssl => false
    
    # ECS compatibility required for data streams
    ecs_compatibility => "v8"
    
    # Enable data streams
    data_stream => true
    
    # Auto-routing: Logstash will use event's [data_stream] fields
    data_stream_auto_routing => true
    
    # Sync data_stream fields back to event
    data_stream_sync_fields => true
    
    # DO NOT set data_stream_dataset/type/namespace here
    # They don't support sprintf and will be ignored when auto_routing is true
  }
  
  # Debug output
  stdout {
    codec => rubydebug {
      metadata => true
    }
  }
}
